trigger:
- main

pr:
- main

pool:
  vmImage: ubuntu-latest


stages:
- stage: Prisma_Cloud_Scan
  displayName: Prisma Cloud Scan
  jobs:
  - job: Prisma_Cloud_Job
    displayName: Prisma Cloud Job
    steps:
    - task: AzureKeyVault@2
      inputs:
        azureSubscription: 'pipeline-connection'
        keyVaultName: 'ts-pipeline-vault'
        secretsFilter: '*'
        runAsPreJob: false
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.8'
        workingDirectory: $(System.DefaultWorkingDirectory)
        script: |
          pip install checkov
          checkov -d . --use-enforcement-rules --bc-api-key $(prisma-access-key)::$(prisma-secret-key) --repo-id prismaiac/bicepgoat --branch main -o cli -o junitxml --output-file-path console,CheckovReport.xml
      displayName: 'Install and Run Checkov'
      env:
        PRISMA_API_URL: https://api.prismacloud.io
    - task: PublishTestResults@2
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/CheckovReport.xml'
        testRunTitle: PrismaCloudTests
      displayName: Publish Test Results
