trigger:
- main

pr:
- main

pool:
  vmImage: ubuntu-latest

variables:
- name: PRISMA_API_URL
  value: https://api.prismacloud.io

steps:
- task: AzureKeyVault@2
  inputs:
    azureSubscription: 'pipeline-connection'
    keyVaultName: 'ts-pipeline-vault'
    secretsFilter: '*'
    runAsPreJob: false
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.8'
  displayName: 'Install Python 3.8'
- script: pip install checkov
  displayName: 'Install Checkov'
- script: checkov -d . --bc-api-key $(prisma-access-key)::$(prisma-secret-key) --repo-id "try-panwiac/bicepgoat" --branch main -o junitxml > prismareport.xml
  displayName: 'Scan with Prisma Cloud'
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    searchFolder: '$(System.DefaultWorkingDirectory)'
    testResultsFiles: '**/*prismaresults.xml'
    mergeTestResults: false
    testRunTitle: Prisma Cloud workspace scan
    failTaskOnFailedTests: false
    publishRunAttachments: true
  displayName: Publish Test Result
